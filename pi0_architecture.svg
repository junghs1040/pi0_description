<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 2620" font-family="'Consolas', 'Monaco', monospace">

  <!-- Background -->
  <rect width="1600" height="2620" fill="#0f1117"/>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TITLE -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <text x="800" y="48" text-anchor="middle" font-size="28" font-weight="bold" fill="#e2e8f0">Ï€â‚€ Transfusion Multi-Expert Transformer â€” ì™„ì „ êµ¬ì¡°ë„</text>
  <text x="800" y="74" text-anchor="middle" font-size="15" fill="#94a3b8">Batch=4 | Prefix=784 tokens (3Ã—256 image + 16 text) | Suffix=33 tokens (1 state + 32 action) | 18 Layers</text>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LEGEND (2ì¤„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- Line 1 -->
  <rect x="20"  y="85" width="14" height="14" rx="2" fill="#3b82f6"/>
  <text x="40"  y="97" font-size="12" fill="#94a3b8">Expert 0 Â· PaliGemma (width=2048)</text>
  <rect x="310" y="85" width="14" height="14" rx="2" fill="#f97316"/>
  <text x="330" y="97" font-size="12" fill="#94a3b8">Expert 1 Â· Action Expert (width=1024)</text>
  <rect x="620" y="85" width="14" height="14" rx="2" fill="#a855f7"/>
  <text x="640" y="97" font-size="12" fill="#94a3b8">Shared Attention Space (head_dim=256)</text>
  <!-- Line 2 -->
  <rect x="20"  y="104" width="14" height="14" rx="2" fill="#10b981"/>
  <text x="40"  y="116" font-size="12" fill="#94a3b8">Flow Matching</text>
  <rect x="200" y="104" width="14" height="14" rx="2" fill="#ef4444"/>
  <text x="220" y="116" font-size="12" fill="#94a3b8">Attention Mask Logic</text>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION 1: INPUT -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <rect x="20" y="126" width="1560" height="2" fill="#334155"/>
  <text x="30" y="138" font-size="16" font-weight="bold" fill="#f1f5f9">â‘  ì…ë ¥ ë°ì´í„° (Step 0-1)</text>

  <!-- Images -->
  <rect x="30" y="148" width="360" height="80" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="210" y="168" text-anchor="middle" font-size="13" font-weight="bold" fill="#3b82f6">ğŸ“· Images (3 cameras)</text>
  <text x="210" y="186" text-anchor="middle" font-size="11" fill="#94a3b8">base_0_rgb    [4,224,224,3] uint8</text>
  <text x="210" y="201" text-anchor="middle" font-size="11" fill="#94a3b8">left_wrist_0  [4,224,224,3] uint8</text>
  <text x="210" y="216" text-anchor="middle" font-size="11" fill="#94a3b8">right_wrist_0 [4,224,224,3] uint8</text>

  <!-- State -->
  <rect x="420" y="148" width="220" height="80" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="530" y="168" text-anchor="middle" font-size="13" font-weight="bold" fill="#3b82f6">ğŸ¦¾ State</text>
  <text x="530" y="188" text-anchor="middle" font-size="11" fill="#94a3b8">[4, 7] float32</text>
  <text x="530" y="205" text-anchor="middle" font-size="11" fill="#64748b">x,y,z,qx,qy,qz,gripper</text>

  <!-- Text -->
  <rect x="670" y="148" width="280" height="80" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="810" y="168" text-anchor="middle" font-size="13" font-weight="bold" fill="#3b82f6">ğŸ“ Text (tokenized)</text>
  <text x="810" y="188" text-anchor="middle" font-size="11" fill="#94a3b8">[4, 16] int32</text>
  <text x="810" y="205" text-anchor="middle" font-size="11" fill="#64748b">"pick up fork" â†’ token IDs</text>

  <!-- Actions -->
  <rect x="980" y="148" width="280" height="80" rx="6" fill="#1e293b" stroke="#10b981" stroke-width="1.5"/>
  <text x="1120" y="168" text-anchor="middle" font-size="13" font-weight="bold" fill="#10b981">ğŸ¯ Actions (train only)</text>
  <text x="1120" y="188" text-anchor="middle" font-size="11" fill="#94a3b8">[4, 32, 7] float32</text>
  <text x="1120" y="205" text-anchor="middle" font-size="11" fill="#64748b">Ground truth expert actions</text>

  <!-- Preprocess note -->
  <rect x="1290" y="148" width="290" height="80" rx="6" fill="#1e293b" stroke="#64748b" stroke-width="1"/>
  <text x="1435" y="167" text-anchor="middle" font-size="12" font-weight="bold" fill="#94a3b8">preprocess_observation()</text>
  <text x="1435" y="184" text-anchor="middle" font-size="11" fill="#64748b">uint8 â†’ float32</text>
  <text x="1435" y="199" text-anchor="middle" font-size="11" fill="#64748b">[0,255] â†’ [-1, 1]</text>
  <text x="1435" y="214" text-anchor="middle" font-size="11" fill="#64748b">image_masks [4] bool</text>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION 2: EMBEDDING -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <rect x="20" y="246" width="1560" height="2" fill="#334155"/>
  <text x="30" y="268" font-size="16" font-weight="bold" fill="#f1f5f9">â‘¡ ì„ë² ë”©: Prefix (Step 2-4) &amp; Suffix (Step 5)</text>

  <!-- â”€â”€â”€ SigLIP (Step 2) â”€â”€â”€ -->
  <!-- ë¸”ë¡: y=278~478 (height=200), ë‚´ìš© 4ê°œ rowë§Œ í¬í•¨ -->
  <rect x="30" y="278" width="480" height="200" rx="8" fill="#172554" stroke="#3b82f6" stroke-width="2"/>
  <text x="270" y="298" text-anchor="middle" font-size="14" font-weight="bold" fill="#3b82f6">SigLIP Vision Encoder (Step 2)</text>
  <text x="270" y="313" text-anchor="middle" font-size="11" fill="#64748b">ViT-So400m/14 Â· pi0.py:114</text>

  <rect x="50" y="320" width="440" height="28" rx="4" fill="#1e3a5f"/>
  <text x="270" y="338" text-anchor="middle" font-size="11" fill="#93c5fd">Patch Embed: [4,224,224,3] â†’ [4,256,588] â†’ Dense(1152) â†’ [4,256,1152]</text>

  <rect x="50" y="354" width="440" height="28" rx="4" fill="#1e3a5f"/>
  <text x="270" y="372" text-anchor="middle" font-size="11" fill="#93c5fd">2D Sinusoidal Pos Embed: [256, 1152] ë”í•˜ê¸°</text>

  <rect x="50" y="388" width="440" height="36" rx="4" fill="#1e3a5f"/>
  <text x="270" y="404" text-anchor="middle" font-size="11" fill="#93c5fd">ViT Transformer Ã— 27 layers</text>
  <text x="270" y="418" text-anchor="middle" font-size="11" fill="#64748b">heads=16, width=1152, mlp=4304</text>

  <rect x="50" y="430" width="440" height="28" rx="4" fill="#1e3a5f"/>
  <text x="270" y="449" text-anchor="middle" font-size="11" fill="#93c5fd">Final Dense: [4,256,1152] â†’ [4,256,2048]</text>

  <!-- ì¶œë ¥ í…ìŠ¤íŠ¸: ë¸”ë¡ ì•„ë˜ (y=478+) -->
  <text x="270" y="493" text-anchor="middle" font-size="11" fill="#f97316">Ã— 3 cameras ê°ê° ë…ë¦½ ì²˜ë¦¬</text>
  <text x="270" y="510" text-anchor="middle" font-size="12" font-weight="bold" fill="#60a5fa">â†“ 3 Ã— [4, 256, 2048] = 768 image tokens</text>

  <!-- â”€â”€â”€ Text Embedder (Step 3) â”€â”€â”€ -->
  <rect x="540" y="278" width="340" height="230" rx="8" fill="#172554" stroke="#3b82f6" stroke-width="2"/>
  <text x="710" y="298" text-anchor="middle" font-size="14" font-weight="bold" fill="#3b82f6">Gemma Embedder (Step 3)</text>
  <text x="710" y="313" text-anchor="middle" font-size="11" fill="#64748b">gemma.py:148 Â· pi0.py:129</text>

  <rect x="560" y="320" width="300" height="50" rx="4" fill="#1e3a5f"/>
  <text x="710" y="340" text-anchor="middle" font-size="11" fill="#93c5fd">Embedding Table Lookup</text>
  <text x="710" y="357" text-anchor="middle" font-size="11" fill="#64748b">[257152, 2048] â†’ [4,16,2048]</text>

  <rect x="560" y="376" width="300" height="40" rx="4" fill="#1e3a5f"/>
  <text x="710" y="392" text-anchor="middle" font-size="11" fill="#93c5fd">Scale Ã— âˆš2048 â‰ˆ 45.25</text>
  <text x="710" y="408" text-anchor="middle" font-size="11" fill="#64748b">ìˆ˜ì¹˜ ì•ˆì •í™”</text>

  <text x="710" y="450" text-anchor="middle" font-size="12" font-weight="bold" fill="#60a5fa">â†“ [4, 16, 2048]</text>

  <!-- Prefix concat (Step 4) -->
  <rect x="540" y="470" width="340" height="38" rx="6" fill="#1d4ed8" stroke="#60a5fa" stroke-width="1.5"/>
  <text x="710" y="485" text-anchor="middle" font-size="12" font-weight="bold" fill="#e0f2fe">Prefix Concat (Step 4)</text>
  <text x="710" y="501" text-anchor="middle" font-size="11" fill="#bfdbfe">[4,768,2048] + [4,16,2048] â†’ [4, 784, 2048]</text>

  <!-- â”€â”€â”€ Suffix / Action Expert (Step 5) â”€â”€â”€ -->
  <rect x="910" y="278" width="670" height="230" rx="8" fill="#1c1105" stroke="#f97316" stroke-width="2"/>
  <text x="1245" y="298" text-anchor="middle" font-size="14" font-weight="bold" fill="#f97316">Action Expert Embedding (Step 5)</text>
  <text x="1245" y="313" text-anchor="middle" font-size="11" fill="#64748b">pi0.py:139-186 Â· Ï€â‚€ ì „ìš© (AdaRMS ì—†ìŒ)</text>

  <!-- Flow matching box -->
  <rect x="930" y="318" width="300" height="90" rx="4" fill="#0f2d1a" stroke="#10b981" stroke-width="1.5"/>
  <text x="1080" y="336" text-anchor="middle" font-size="12" font-weight="bold" fill="#10b981">Flow Matching (í•™ìŠµì‹œ)</text>
  <text x="1080" y="352" text-anchor="middle" font-size="11" fill="#6ee7b7">noise ~ N(0,I)  [4,32,7]</text>
  <text x="1080" y="367" text-anchor="middle" font-size="11" fill="#6ee7b7">t ~ Beta(1.5, 1.0)  [4]</text>
  <text x="1080" y="382" text-anchor="middle" font-size="11" fill="#6ee7b7">x_t = tÂ·noise + (1-t)Â·actions</text>
  <text x="1080" y="397" text-anchor="middle" font-size="11" fill="#6ee7b7">u_t = noise - actions  (target)</text>

  <!-- State proj -->
  <rect x="930" y="416" width="140" height="52" rx="4" fill="#2d1b0e" stroke="#fb923c" stroke-width="1"/>
  <text x="1000" y="433" text-anchor="middle" font-size="11" fill="#fb923c">state_proj</text>
  <text x="1000" y="449" text-anchor="middle" font-size="11" fill="#94a3b8">Linear(7â†’1024)</text>
  <text x="1000" y="464" text-anchor="middle" font-size="11" fill="#60a5fa">[4,1,1024]</text>

  <!-- action in proj -->
  <rect x="1080" y="416" width="160" height="52" rx="4" fill="#2d1b0e" stroke="#fb923c" stroke-width="1"/>
  <text x="1160" y="433" text-anchor="middle" font-size="11" fill="#fb923c">action_in_proj</text>
  <text x="1160" y="449" text-anchor="middle" font-size="11" fill="#94a3b8">Linear(7â†’1024)</text>
  <text x="1160" y="464" text-anchor="middle" font-size="11" fill="#60a5fa">[4,32,1024]</text>

  <!-- time emb -->
  <rect x="1250" y="416" width="310" height="52" rx="4" fill="#2d1b0e" stroke="#fb923c" stroke-width="1"/>
  <text x="1405" y="433" text-anchor="middle" font-size="11" fill="#fb923c">Time Emb (sincos PE)</text>
  <text x="1405" y="449" text-anchor="middle" font-size="11" fill="#94a3b8">posemb_sincos(t, 1024, 4e-3, 4.0)</text>
  <text x="1405" y="464" text-anchor="middle" font-size="11" fill="#60a5fa">[4,1024] â†’ repeat â†’ [4,32,1024]</text>

  <!-- action + time MLP -->
  <rect x="1080" y="474" width="480" height="30" rx="4" fill="#2d1b0e" stroke="#fb923c" stroke-width="1"/>
  <text x="1320" y="488" text-anchor="middle" font-size="11" fill="#fb923c">concat([action,time])â†’[4,32,2048] â†’ MLP_in(2048â†’1024)+SiLU â†’ MLP_out(1024â†’1024)</text>

  <!-- suffix output -->
  <text x="1245" y="518" text-anchor="middle" font-size="12" font-weight="bold" fill="#fb923c">â†“ concat([state,actions]) â†’ [4, 33, 1024]</text>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION 3: AR MASK -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <rect x="20" y="524" width="1560" height="2" fill="#334155"/>
  <text x="30" y="546" font-size="16" font-weight="bold" fill="#f1f5f9">â‘¢ Attention Mask ìƒì„± (Step 6) â€” ar_mask â†’ cumsum â†’ [4, 817, 817]</text>

  <!-- AR mask visual -->
  <rect x="30" y="556" width="1540" height="200" rx="8" fill="#1e0a0a" stroke="#ef4444" stroke-width="2"/>

  <!-- ar_mask sequence -->
  <text x="50" y="576" font-size="13" font-weight="bold" fill="#ef4444">ar_mask [817]:</text>
  <!-- prefix blocks -->
  <rect x="180" y="560" width="235" height="26" rx="3" fill="#1d4ed8"/>
  <text x="298" y="577" text-anchor="middle" font-size="11" fill="#93c5fd">image_0 (256) FalseÃ—256</text>
  <rect x="420" y="560" width="235" height="26" rx="3" fill="#1d4ed8"/>
  <text x="537" y="577" text-anchor="middle" font-size="11" fill="#93c5fd">image_1 (256) FalseÃ—256</text>
  <rect x="660" y="560" width="235" height="26" rx="3" fill="#1d4ed8"/>
  <text x="777" y="577" text-anchor="middle" font-size="11" fill="#93c5fd">image_2 (256) FalseÃ—256</text>
  <rect x="900" y="560" width="110" height="26" rx="3" fill="#1d4ed8"/>
  <text x="955" y="577" text-anchor="middle" font-size="11" fill="#93c5fd">text (16) FÃ—16</text>
  <rect x="1015" y="560" width="50" height="26" rx="3" fill="#f97316"/>
  <text x="1040" y="577" text-anchor="middle" font-size="11" fill="#fff">state T</text>
  <rect x="1070" y="560" width="50" height="26" rx="3" fill="#f97316"/>
  <text x="1095" y="577" text-anchor="middle" font-size="11" fill="#fff">actâ‚€ T</text>
  <rect x="1125" y="560" width="420" height="26" rx="3" fill="#2d4a2d"/>
  <text x="1335" y="577" text-anchor="middle" font-size="11" fill="#86efac">actâ‚â€¦actâ‚ƒâ‚ (31 tokens) FalseÃ—31</text>

  <!-- cumsum result -->
  <text x="50" y="608" font-size="13" font-weight="bold" fill="#f59e0b">cumsum  [817]:</text>
  <rect x="180" y="592" width="740" height="26" rx="3" fill="#1c1407" stroke="#f59e0b" stroke-width="1"/>
  <text x="550" y="609" text-anchor="middle" font-size="11" fill="#fcd34d">0, 0, 0, â€¦ 0  (784ê°œ = prefix)</text>
  <rect x="1015" y="592" width="50" height="26" rx="3" fill="#1c1407" stroke="#f59e0b" stroke-width="1"/>
  <text x="1040" y="609" text-anchor="middle" font-size="11" fill="#fcd34d">1</text>
  <rect x="1070" y="592" width="475" height="26" rx="3" fill="#1c1407" stroke="#f59e0b" stroke-width="1"/>
  <text x="1307" y="609" text-anchor="middle" font-size="11" fill="#fcd34d">2, 2, 2, â€¦ 2  (32ê°œ = actions)</text>

  <!-- Attention pattern table -->
  <text x="50" y="640" font-size="13" font-weight="bold" fill="#ef4444">Attention í—ˆìš© ê·œì¹™: cumsum[key] â‰¤ cumsum[query]</text>

  <!-- table -->
  <rect x="50" y="650" width="740" height="96" rx="4" fill="#150505"/>
  <!-- headers -->
  <rect x="50" y="650" width="740" height="20" rx="4" fill="#3f0f0f"/>
  <text x="175" y="664" text-anchor="middle" font-size="11" fill="#fca5a5">Query \ Key â†’</text>
  <text x="395" y="664" text-anchor="middle" font-size="11" fill="#3b82f6">Prefix (cum=0)</text>
  <text x="615" y="664" text-anchor="middle" font-size="11" fill="#f97316">State (cum=1)</text>
  <text x="735" y="664" text-anchor="middle" font-size="11" fill="#f97316">Action (cum=2)</text>
  <!-- row1 -->
  <text x="175" y="682" text-anchor="middle" font-size="11" fill="#3b82f6">Prefix (cum=0)</text>
  <text x="395" y="682" text-anchor="middle" font-size="12" fill="#4ade80">âœ“  0â‰¤0</text>
  <text x="615" y="682" text-anchor="middle" font-size="12" fill="#f87171">âœ—  1â‰¤0 false</text>
  <text x="735" y="682" text-anchor="middle" font-size="12" fill="#f87171">âœ—  2â‰¤0 false</text>
  <!-- row2 -->
  <text x="175" y="700" text-anchor="middle" font-size="11" fill="#f97316">State (cum=1)</text>
  <text x="395" y="700" text-anchor="middle" font-size="12" fill="#4ade80">âœ“  0â‰¤1</text>
  <text x="615" y="700" text-anchor="middle" font-size="12" fill="#4ade80">âœ“  1â‰¤1</text>
  <text x="735" y="700" text-anchor="middle" font-size="12" fill="#f87171">âœ—  2â‰¤1 false</text>
  <!-- row3 -->
  <text x="175" y="718" text-anchor="middle" font-size="11" fill="#f97316">Action (cum=2)</text>
  <text x="395" y="718" text-anchor="middle" font-size="12" fill="#4ade80">âœ“  0â‰¤2</text>
  <text x="615" y="718" text-anchor="middle" font-size="12" fill="#4ade80">âœ“  1â‰¤2</text>
  <text x="735" y="718" text-anchor="middle" font-size="12" fill="#4ade80">âœ“  2â‰¤2</text>
  <!-- row4 -->
  <text x="175" y="736" text-anchor="middle" font-size="11" fill="#64748b">ìš”ì•½</text>
  <text x="395" y="736" text-anchor="middle" font-size="11" fill="#93c5fd">ì–‘ë°©í–¥ attention</text>
  <text x="615" y="736" text-anchor="middle" font-size="11" fill="#fed7aa">prefixë§Œ ì°¸ì¡°</text>
  <text x="735" y="736" text-anchor="middle" font-size="11" fill="#fed7aa">ì „ë¶€ ì°¸ì¡° ì–‘ë°©í–¥</text>

  <!-- KV cache benefit -->
  <rect x="820" y="650" width="730" height="96" rx="4" fill="#0a1628" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="1185" y="669" text-anchor="middle" font-size="13" font-weight="bold" fill="#60a5fa">ğŸ”‘ KV Cache ì¬ì‚¬ìš© ê·¼ê±° (ì¶”ë¡ ì‹œ)</text>
  <text x="840" y="690" font-size="12" fill="#93c5fd">PrefixëŠ” Suffixë¥¼ ë³¼ ìˆ˜ ì—†ìŒ â†’ Prefix KVëŠ” Suffixì— ì˜í–¥ë°›ì§€ ì•ŠìŒ</text>
  <text x="840" y="708" font-size="12" fill="#93c5fd">âˆ´ Prefix 1íšŒ ê³„ì‚° â†’ KV Cache ì €ì¥ â†’ 10ë²ˆ denoising loop ì¬ì‚¬ìš©</text>
  <text x="840" y="726" font-size="12" fill="#64748b">18 layers Ã— [4, 784, 1, 256]  ì €ì¥</text>
  <text x="840" y="744" font-size="12" fill="#fbbf24">ì„±ëŠ¥: Prefix 1íšŒ + Suffix 10íšŒ = ì´ 11íšŒ forward (Ã—10 ì ˆì•½)</text>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION 4: ONE TRANSFORMER BLOCK (DETAIL) -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <rect x="20" y="772" width="1560" height="2" fill="#334155"/>
  <text x="30" y="794" font-size="16" font-weight="bold" fill="#f1f5f9">â‘£ Transformer Block ìƒì„¸ (Step 7) â€” 18 layers ë™ì¼ êµ¬ì¡° ë°˜ë³µ</text>

  <!-- â”€â”€â”€ Outer block container â”€â”€â”€ -->
  <rect x="30" y="804" width="1540" height="690" rx="10" fill="#0f1520" stroke="#475569" stroke-width="2"/>

  <!-- Layer label -->
  <rect x="30" y="804" width="1540" height="28" rx="8" fill="#1e2d45"/>
  <text x="800" y="822" text-anchor="middle" font-size="13" fill="#94a3b8">Block (gemma.py:284) â€” nn.scan Ã— 18 â€” each block: configs=[PaliGemma(2048), ActionExpert(1024)]</text>

  <!-- â”€â”€â”€ Input xs â”€â”€â”€ -->
  <text x="390" y="856" text-anchor="middle" font-size="12" font-weight="bold" fill="#3b82f6">xs[0] prefix_tokens [4, 784, 2048]</text>
  <text x="1210" y="856" text-anchor="middle" font-size="12" font-weight="bold" fill="#f97316">xs[1] suffix_tokens [4, 33, 1024]</text>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7-1: PRE-ATTN RMSNORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <rect x="50" y="865" width="680" height="45" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="390" y="882" text-anchor="middle" font-size="12" font-weight="bold" fill="#60a5fa">7-1 Â· Pre-Attention RMSNorm (Expert 0)</text>
  <text x="390" y="899" text-anchor="middle" font-size="11" fill="#94a3b8">RMS(x[2048]) â†’ normed Ã— (1+scale[2048]) | gemma.py:113</text>

  <rect x="870" y="865" width="680" height="45" rx="6" fill="#2d1b0e" stroke="#f97316" stroke-width="1.5"/>
  <text x="1210" y="882" text-anchor="middle" font-size="12" font-weight="bold" fill="#fb923c">7-1 Â· Pre-Attention RMSNorm (Expert 1)</text>
  <text x="1210" y="899" text-anchor="middle" font-size="11" fill="#94a3b8">RMS(x[1024]) â†’ normed Ã— (1+scale[1024]) | Ï€â‚€: no adaRMS</text>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7-2: QKV Projection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <!-- Expert 0 Q -->
  <rect x="50" y="924" width="200" height="60" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="150" y="942" text-anchor="middle" font-size="11" font-weight="bold" fill="#60a5fa">Q Einsum (Exp 0)</text>
  <text x="150" y="957" text-anchor="middle" font-size="11" fill="#94a3b8">[8, 2048, 256]</text>
  <text x="150" y="972" text-anchor="middle" font-size="10" fill="#64748b">BTD,NDHâ†’BTNH</text>

  <!-- Expert 0 KV -->
  <rect x="260" y="924" width="200" height="60" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="360" y="942" text-anchor="middle" font-size="11" font-weight="bold" fill="#60a5fa">KV Einsum (Exp 0)</text>
  <text x="360" y="957" text-anchor="middle" font-size="11" fill="#94a3b8">[2,1, 2048, 256]</text>
  <text x="360" y="972" text-anchor="middle" font-size="10" fill="#64748b">BSD,2KDHâ†’2BSKH</text>

  <!-- Expert 0 Q shape out -->
  <rect x="50" y="990" width="200" height="26" rx="3" fill="#0f1e35" stroke="#1d4ed8"/>
  <text x="150" y="1007" text-anchor="middle" font-size="11" fill="#93c5fd">qâ‚€ [4, 784, 8, 256]</text>
  <rect x="260" y="990" width="200" height="26" rx="3" fill="#0f1e35" stroke="#1d4ed8"/>
  <text x="360" y="1007" text-anchor="middle" font-size="11" fill="#93c5fd">kâ‚€,vâ‚€ [4, 784, 1, 256]</text>

  <!-- Expert 1 Q -->
  <rect x="870" y="924" width="200" height="60" rx="6" fill="#2d1b0e" stroke="#f97316" stroke-width="1.5"/>
  <text x="970" y="942" text-anchor="middle" font-size="11" font-weight="bold" fill="#fb923c">Q Einsum (Exp 1)</text>
  <text x="970" y="957" text-anchor="middle" font-size="11" fill="#94a3b8">[8, 1024, 256]  â†1024</text>
  <text x="970" y="972" text-anchor="middle" font-size="10" fill="#64748b">BTD,NDHâ†’BTNH</text>

  <!-- Expert 1 KV -->
  <rect x="1080" y="924" width="200" height="60" rx="6" fill="#2d1b0e" stroke="#f97316" stroke-width="1.5"/>
  <text x="1180" y="942" text-anchor="middle" font-size="11" font-weight="bold" fill="#fb923c">KV Einsum (Exp 1)</text>
  <text x="1180" y="957" text-anchor="middle" font-size="11" fill="#94a3b8">[2,1, 1024, 256]  â†1024</text>
  <text x="1180" y="972" text-anchor="middle" font-size="10" fill="#64748b">BSD,2KDHâ†’2BSKH</text>

  <!-- Expert 1 Q shape out -->
  <rect x="870" y="990" width="200" height="26" rx="3" fill="#1c0f05" stroke="#c2410c"/>
  <text x="970" y="1007" text-anchor="middle" font-size="11" fill="#fed7aa">qâ‚ [4, 33, 8, 256]</text>
  <rect x="1080" y="990" width="200" height="26" rx="3" fill="#1c0f05" stroke="#c2410c"/>
  <text x="1180" y="1007" text-anchor="middle" font-size="11" fill="#fed7aa">kâ‚,vâ‚ [4, 33, 1, 256]</text>

  <!-- â”€â”€â”€ CONCAT â”€â”€â”€ (QKV output ë¼ë²¨ ì•„ë˜ y=1030ì— ë°°ì¹˜) -->
  <rect x="430" y="1034" width="400" height="46" rx="6" fill="#1e1b40" stroke="#a855f7" stroke-width="2"/>
  <text x="630" y="1052" text-anchor="middle" font-size="12" font-weight="bold" fill="#c084fc">jnp.concatenate(axis=1)</text>
  <text x="630" y="1068" text-anchor="middle" font-size="11" fill="#a78bfa">q: [4,817,8,256]  k,v: [4,817,1,256]</text>

  <!-- CONCAT arrows: ì•„ë˜ë¥¼ í–¥í•˜ëŠ” í™”ì‚´í‘œ (QKV outputâ†’CONCAT) -->
  <line x1="150" y1="1016" x2="630" y2="1034" stroke="#a855f7" stroke-width="1.2" stroke-dasharray="4,2"/>
  <line x1="970" y1="1016" x2="630" y2="1034" stroke="#a855f7" stroke-width="1.2" stroke-dasharray="4,2"/>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7-3: RoPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <rect x="430" y="1096" width="400" height="50" rx="6" fill="#1e1b40" stroke="#a855f7" stroke-width="1.5"/>
  <text x="630" y="1114" text-anchor="middle" font-size="12" font-weight="bold" fill="#c084fc">7-3 Â· RoPE (Rotary Position Embedding)</text>
  <text x="630" y="1130" text-anchor="middle" font-size="11" fill="#94a3b8">Q,Kì— ìœ„ì¹˜ë³„ íšŒì „ ë³€í™˜ Â· q *= 1/âˆš256 | gemma.py:424</text>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7-4: GQA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <rect x="280" y="1164" width="700" height="110" rx="8" fill="#1a0d2e" stroke="#a855f7" stroke-width="2"/>
  <text x="630" y="1184" text-anchor="middle" font-size="13" font-weight="bold" fill="#c084fc">7-4 Â· Grouped Query Attention (GQA) â€” Shared</text>
  <text x="630" y="1201" text-anchor="middle" font-size="11" fill="#94a3b8">q: [4,817,1,8,256]  k,v: [4,817,1,256]  |  gemma.py:216</text>
  <text x="630" y="1217" text-anchor="middle" font-size="11" fill="#94a3b8">logits = einsum(BTKGH,BSKHâ†’BKGTS)  â†’  [4,1,8,817,817]</text>
  <text x="630" y="1233" text-anchor="middle" font-size="11" fill="#94a3b8">masked_logits: âœ— â†’ -2.38e38 â†’ softmax â†’ probs â†’ encoded [4,817,8,256]</text>
  <text x="630" y="1249" text-anchor="middle" font-size="11" fill="#ef4444">attn_mask [4,817,817]: ë‘ expert í† í°ì´ í•˜ë‚˜ì˜ attention matrix ê³µìœ </text>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7-5: Output Proj â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <rect x="50" y="1292" width="380" height="50" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="240" y="1310" text-anchor="middle" font-size="12" font-weight="bold" fill="#60a5fa">7-5 Â· Output Proj (Expert 0)</text>
  <text x="240" y="1326" text-anchor="middle" font-size="11" fill="#94a3b8">encoded[:,0:784] â†’ Einsum[8,256,2048] â†’ [4,784,2048]</text>

  <rect x="830" y="1292" width="380" height="50" rx="6" fill="#2d1b0e" stroke="#f97316" stroke-width="1.5"/>
  <text x="1020" y="1310" text-anchor="middle" font-size="12" font-weight="bold" fill="#fb923c">7-5 Â· Output Proj (Expert 1)</text>
  <text x="1020" y="1326" text-anchor="middle" font-size="11" fill="#94a3b8">encoded[:,784:817] â†’ Einsum[8,256,1024] â†’ [4,33,1024]</text>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7-6: Residual 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <rect x="50" y="1358" width="380" height="36" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1"/>
  <text x="240" y="1374" text-anchor="middle" font-size="12" fill="#60a5fa">7-6 Â· Residual: xs[0] = xs[0] + out[0]  [4,784,2048]</text>
  <text x="240" y="1388" text-anchor="middle" font-size="11" fill="#64748b">gate=None (Ï€â‚€) â†’ ë‹¨ìˆœ ë§ì…ˆ</text>

  <rect x="830" y="1358" width="380" height="36" rx="6" fill="#2d1b0e" stroke="#f97316" stroke-width="1"/>
  <text x="1020" y="1374" text-anchor="middle" font-size="12" fill="#fb923c">7-6 Â· Residual: xs[1] = xs[1] + out[1]  [4,33,1024]</text>
  <text x="1020" y="1388" text-anchor="middle" font-size="11" fill="#64748b">gate=None (Ï€â‚€) â†’ ë‹¨ìˆœ ë§ì…ˆ</text>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7-7: FFN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <rect x="50" y="1410" width="380" height="76" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="240" y="1428" text-anchor="middle" font-size="12" font-weight="bold" fill="#60a5fa">7-7 Â· FFN (Expert 0) â€” GeGLU</text>
  <text x="240" y="1444" text-anchor="middle" font-size="11" fill="#94a3b8">pre_ffw_norm â†’ gating[2,2048,16384]</text>
  <text x="240" y="1460" text-anchor="middle" font-size="11" fill="#94a3b8">gelu(gate)Ã—ff1 â†’ [4,784,16384] â†’ linear[16384,2048]</text>
  <text x="240" y="1476" text-anchor="middle" font-size="11" fill="#94a3b8">+ Residual â†’ xs[0] [4, 784, 2048]</text>

  <rect x="830" y="1410" width="380" height="76" rx="6" fill="#2d1b0e" stroke="#f97316" stroke-width="1.5"/>
  <text x="1020" y="1428" text-anchor="middle" font-size="12" font-weight="bold" fill="#fb923c">7-7 Â· FFN (Expert 1) â€” GeGLU</text>
  <text x="1020" y="1444" text-anchor="middle" font-size="11" fill="#94a3b8">pre_ffw_norm â†’ gating[2,1024,4096]</text>
  <text x="1020" y="1460" text-anchor="middle" font-size="11" fill="#94a3b8">gelu(gate)Ã—ff1 â†’ [4,33,4096] â†’ linear[4096,1024]</text>
  <text x="1020" y="1476" text-anchor="middle" font-size="11" fill="#94a3b8">+ Residual â†’ xs[1] [4, 33, 1024]</text>

  <!-- middle annotation -->
  <rect x="450" y="1410" width="360" height="76" rx="6" fill="#0f1520" stroke="#475569" stroke-width="1"/>
  <text x="630" y="1430" text-anchor="middle" font-size="12" font-weight="bold" fill="#94a3b8">ê° Expert ë…ë¦½ FFN</text>
  <text x="630" y="1448" text-anchor="middle" font-size="11" fill="#64748b">ê³µìœ  attention í›„ ê°œì¸ ì²˜ë¦¬</text>
  <text x="630" y="1464" text-anchor="middle" font-size="11" fill="#64748b">Exp 0: Ã—8 í™•ì¥  2048â†’16384</text>
  <text x="630" y="1480" text-anchor="middle" font-size="11" fill="#64748b">Exp 1: Ã—4 í™•ì¥  1024â†’4096</text>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION 5: 18 LAYERS SCAN -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <rect x="20" y="1516" width="1560" height="2" fill="#334155"/>
  <text x="30" y="1538" font-size="16" font-weight="bold" fill="#f1f5f9">â‘¤ nn.scan â€” 18 Layers ë°˜ë³µ (Step 8)</text>

  <rect x="30" y="1548" width="1540" height="56" rx="8" fill="#1a1a2e" stroke="#6366f1" stroke-width="2"/>
  <!-- Layer boxes -->
  <rect x="60" y="1556" width="80" height="36" rx="4" fill="#1d4ed8"/>
  <text x="100" y="1577" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">Layer 0</text>
  <text x="100" y="1590" text-anchor="middle" font-size="10" fill="#bfdbfe">distinct W</text>
  <rect x="160" y="1566" width="16" height="4" fill="#6366f1"/>
  <rect x="196" y="1556" width="80" height="36" rx="4" fill="#1d4ed8"/>
  <text x="236" y="1577" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">Layer 1</text>
  <text x="236" y="1590" text-anchor="middle" font-size="10" fill="#bfdbfe">distinct W</text>
  <rect x="296" y="1566" width="16" height="4" fill="#6366f1"/>
  <rect x="332" y="1556" width="60" height="36" rx="4" fill="#374151"/>
  <text x="362" y="1579" text-anchor="middle" font-size="14" fill="#9ca3af">Â·Â·Â·</text>
  <rect x="412" y="1566" width="16" height="4" fill="#6366f1"/>
  <rect x="448" y="1556" width="80" height="36" rx="4" fill="#1d4ed8"/>
  <text x="488" y="1577" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">Layer 17</text>
  <text x="488" y="1590" text-anchor="middle" font-size="10" fill="#bfdbfe">distinct W</text>

  <text x="750" y="1586" font-size="13" fill="#6366f1">â†’</text>
  <rect x="780" y="1552" width="760" height="44" rx="6" fill="#0f172a" stroke="#6366f1" stroke-width="1"/>
  <text x="1160" y="1573" text-anchor="middle" font-size="12" fill="#a5b4fc">ë§¤ layer: êµ¬ì¡° ë™ì¼, ê°€ì¤‘ì¹˜ ë…ë¦½ (variable_axes params:0)</text>
  <text x="1160" y="1590" text-anchor="middle" font-size="12" fill="#818cf8">18íšŒ cross-attention â†’ image/language ì •ë³´ê°€ action í† í°ì— ì ì°¨ ìœµí•©</text>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION 6: FINAL NORM + OUTPUT -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <rect x="20" y="1620" width="1560" height="2" fill="#334155"/>
  <text x="30" y="1642" font-size="16" font-weight="bold" fill="#f1f5f9">â‘¥ Final Norm â†’ Velocity â†’ Loss (Step 9-11)</text>

  <!-- Final norm -->
  <rect x="30" y="1652" width="350" height="58" rx="6" fill="#1e293b" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="205" y="1671" text-anchor="middle" font-size="12" font-weight="bold" fill="#60a5fa">Step 9 Â· Final RMSNorm</text>
  <text x="205" y="1687" text-anchor="middle" font-size="11" fill="#94a3b8">prefix_out [4, 784, 2048]</text>
  <text x="205" y="1702" text-anchor="middle" font-size="11" fill="#94a3b8">suffix_out  [4, 33, 1024]</text>

  <text x="400" y="1684" text-anchor="middle" font-size="18" fill="#64748b">â†’</text>

  <!-- Extract action tokens -->
  <rect x="420" y="1652" width="300" height="58" rx="6" fill="#2d1b0e" stroke="#f97316" stroke-width="1.5"/>
  <text x="570" y="1671" text-anchor="middle" font-size="12" font-weight="bold" fill="#fb923c">Step 10 Â· Velocity Prediction</text>
  <text x="570" y="1687" text-anchor="middle" font-size="11" fill="#94a3b8">suffix_out[:, -32:] â†’ [4,32,1024]</text>
  <text x="570" y="1702" text-anchor="middle" font-size="11" fill="#94a3b8">action_out_proj Linear(1024â†’7)</text>

  <text x="745" y="1684" text-anchor="middle" font-size="18" fill="#64748b">â†’</text>

  <!-- v_t -->
  <rect x="760" y="1652" width="200" height="58" rx="6" fill="#0f2d1a" stroke="#10b981" stroke-width="2"/>
  <text x="860" y="1671" text-anchor="middle" font-size="13" font-weight="bold" fill="#10b981">v_t [4, 32, 7]</text>
  <text x="860" y="1687" text-anchor="middle" font-size="11" fill="#6ee7b7">Predicted velocity</text>
  <text x="860" y="1702" text-anchor="middle" font-size="11" fill="#6ee7b7">í˜„ì¬ ìœ„ì¹˜ì˜ ì´ë™ ë°©í–¥</text>

  <text x="985" y="1684" text-anchor="middle" font-size="18" fill="#64748b">â†’</text>

  <!-- Loss -->
  <rect x="1000" y="1652" width="540" height="58" rx="6" fill="#0f2d1a" stroke="#10b981" stroke-width="2"/>
  <text x="1270" y="1671" text-anchor="middle" font-size="13" font-weight="bold" fill="#10b981">Step 11 Â· Flow Matching Loss</text>
  <text x="1270" y="1687" text-anchor="middle" font-size="12" fill="#6ee7b7">u_t = noise - actions  (target velocity)</text>
  <text x="1270" y="1702" text-anchor="middle" font-size="12" fill="#6ee7b7">loss = mean_squared_error(v_t, u_t)  â†’ [4, 32]</text>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION 7: INFERENCE DENOISING LOOP -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <rect x="20" y="1726" width="1560" height="2" fill="#334155"/>
  <text x="30" y="1748" font-size="16" font-weight="bold" fill="#f1f5f9">â‘¦ ì¶”ë¡  Denoising Loop â€” Flow Matching Sampling (Euler Integration)</text>

  <rect x="30" y="1758" width="1540" height="320" rx="10" fill="#080f1e" stroke="#6366f1" stroke-width="2"/>

  <!-- Phase 1: Prefix cache -->
  <rect x="50" y="1772" width="460" height="140" rx="8" fill="#0f1e35" stroke="#3b82f6" stroke-width="2"/>
  <text x="280" y="1791" text-anchor="middle" font-size="13" font-weight="bold" fill="#3b82f6">Phase 1: Prefix KV Cache (1íšŒ)</text>
  <text x="280" y="1807" text-anchor="middle" font-size="11" fill="#93c5fd">embed_prefix(obs) â†’ prefix_tokens [4,784,2048]</text>
  <text x="280" y="1823" text-anchor="middle" font-size="11" fill="#93c5fd">llm([prefix_tokens, None]) â†’ kv_cache</text>
  <text x="280" y="1839" text-anchor="middle" font-size="11" fill="#6ee7b7">ì €ì¥: 18 layers Ã— (k[4,784,1,256], v[4,784,1,256])</text>
  <text x="280" y="1855" text-anchor="middle" font-size="11" fill="#64748b">ì´ë¯¸ì§€/ì–¸ì–´ ê´€ì°° ê³ ì • â†’ 1íšŒë§Œ ê³„ì‚°</text>
  <rect x="70" y="1866" width="420" height="36" rx="4" fill="#0a3060" stroke="#3b82f6" stroke-width="1"/>
  <text x="280" y="1888" text-anchor="middle" font-size="12" fill="#93c5fd">noise = N(0,I)  â†’  x_t = noise   (t=1.0)</text>

  <!-- Arrow Phase 1 â†’ Phase 2 -->
  <line x1="510" y1="1842" x2="580" y2="1842" stroke="#6366f1" stroke-width="2" marker-end="url(#arr)"/>
  <text x="545" y="1834" text-anchor="middle" font-size="11" fill="#6366f1">Ã—10</text>

  <!-- Phase 2: Denoising loop -->
  <rect x="580" y="1772" width="960" height="280" rx="8" fill="#0f172a" stroke="#6366f1" stroke-width="2"/>
  <text x="1060" y="1791" text-anchor="middle" font-size="13" font-weight="bold" fill="#a5b4fc">Phase 2: Denoising Loop â€” jax.lax.while_loop</text>
  <text x="1060" y="1807" text-anchor="middle" font-size="11" fill="#818cf8">t: 1.0 â†’ 0.9 â†’ 0.8 â†’ Â·Â·Â· â†’ 0.1 (num_steps=10, dt=-0.1)</text>

  <!-- Step boxes in loop -->
  <rect x="600" y="1816" width="360" height="38" rx="4" fill="#1e1b40" stroke="#a855f7" stroke-width="1.5"/>
  <text x="780" y="1832" text-anchor="middle" font-size="11" fill="#c084fc">â‘  embed_suffix(obs, x_t, t) â†’ suffix_tokens [4,33,1024]</text>
  <text x="780" y="1847" text-anchor="middle" font-size="11" fill="#94a3b8">action_in_proj + time_emb + MLP (ë§¤ step ì¬ê³„ì‚°)</text>

  <rect x="600" y="1862" width="360" height="38" rx="4" fill="#1e1b40" stroke="#a855f7" stroke-width="1.5"/>
  <text x="780" y="1878" text-anchor="middle" font-size="11" fill="#c084fc">â‘¡ full_attn_mask: [4, 33, 817]</text>
  <text x="780" y="1893" text-anchor="middle" font-size="11" fill="#94a3b8">prefix_mask [b,33,784] â€– suffix_mask [b,33,33]</text>

  <rect x="600" y="1908" width="360" height="38" rx="4" fill="#1e1b40" stroke="#a855f7" stroke-width="1.5"/>
  <text x="780" y="1924" text-anchor="middle" font-size="11" fill="#c084fc">â‘¢ llm([None, suffix_tokens], kv_cache=cache)</text>
  <text x="780" y="1939" text-anchor="middle" font-size="11" fill="#94a3b8">Expert 1ë§Œ ì‹¤í–‰, KV cacheì—ì„œ K/V ê°€ì ¸ì˜´</text>

  <rect x="600" y="1954" width="360" height="38" rx="4" fill="#1e1b40" stroke="#a855f7" stroke-width="1.5"/>
  <text x="780" y="1970" text-anchor="middle" font-size="11" fill="#c084fc">â‘£ v_t = action_out_proj(suffix_out[:,-32:])</text>
  <text x="780" y="1985" text-anchor="middle" font-size="11" fill="#94a3b8">Linear(1024â†’7) â†’ v_t [4, 32, 7]</text>

  <rect x="600" y="2000" width="360" height="36" rx="4" fill="#0f2d1a" stroke="#10b981" stroke-width="1.5"/>
  <text x="780" y="2018" text-anchor="middle" font-size="12" font-weight="bold" fill="#10b981">â‘¤ x_t = x_t + dt Ã— v_t  (Euler step)</text>
  <text x="780" y="2033" text-anchor="middle" font-size="11" fill="#6ee7b7">x_t ì—…ë°ì´íŠ¸, t += dt (-0.1)</text>

  <!-- Result -->
  <rect x="990" y="1816" width="530" height="220" rx="8" fill="#0a1628" stroke="#10b981" stroke-width="2"/>
  <text x="1255" y="1838" text-anchor="middle" font-size="14" font-weight="bold" fill="#10b981">ìµœì¢… ê²°ê³¼: x_0 [4, 32, 7]</text>
  <text x="1255" y="1858" text-anchor="middle" font-size="12" fill="#6ee7b7">Pure noise â†’ Clean actions</text>
  <text x="1010" y="1884" font-size="11" fill="#94a3b8">t=1.0: x_t = noise (ì™„ì „ ëœë¤)</text>
  <text x="1010" y="1902" font-size="11" fill="#94a3b8">t=0.9: x_t â‰ˆ noise (ì•½ê°„ ì •ì œ)</text>
  <text x="1010" y="1920" font-size="11" fill="#94a3b8">t=0.5: x_t â‰ˆ ì¤‘ê°„ ìƒíƒœ</text>
  <text x="1010" y="1938" font-size="11" fill="#6ee7b7">t=0.0: x_0 = clean actions âœ“</text>

  <rect x="1010" y="1952" width="490" height="70" rx="6" fill="#051a0d" stroke="#10b981" stroke-width="1"/>
  <text x="1255" y="1972" text-anchor="middle" font-size="12" font-weight="bold" fill="#10b981">ê³„ì‚° ë¹„ìš© ë¹„êµ</text>
  <text x="1255" y="1990" text-anchor="middle" font-size="11" fill="#6ee7b7">KV Cache ì—†ì´: 10 Ã— full forward = 110íšŒ</text>
  <text x="1255" y="2006" text-anchor="middle" font-size="11" fill="#4ade80">KV Cache ìˆìŒ: 1 + 10 Ã— suffix = 11íšŒ  (Ã—10 ì ˆì•½)</text>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION 8: WEIGHT SUMMARY TABLE -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <rect x="20" y="2094" width="1560" height="2" fill="#334155"/>
  <text x="30" y="2116" font-size="16" font-weight="bold" fill="#f1f5f9">â‘§ íŒŒë¼ë¯¸í„° êµ¬ì¡° ìš”ì•½ â€” Per Layer</text>

  <!-- Table header -->
  <rect x="30" y="2126" width="1540" height="28" rx="4" fill="#1e2d45"/>
  <text x="150" y="2144" text-anchor="middle" font-size="12" font-weight="bold" fill="#e2e8f0">ì»´í¬ë„ŒíŠ¸</text>
  <text x="430" y="2144" text-anchor="middle" font-size="12" font-weight="bold" fill="#3b82f6">Expert 0 (PaliGemma 2B)</text>
  <text x="780" y="2144" text-anchor="middle" font-size="12" font-weight="bold" fill="#f97316">Expert 1 (Action Expert 300M)</text>
  <text x="1100" y="2144" text-anchor="middle" font-size="12" font-weight="bold" fill="#a855f7">ê³µìœ  ì—¬ë¶€</text>
  <text x="1380" y="2144" text-anchor="middle" font-size="12" font-weight="bold" fill="#94a3b8">ë¹„ê³ </text>

  <!-- Row 1 -->
  <rect x="30" y="2154" width="1540" height="28" rx="0" fill="#131e2e"/>
  <text x="150" y="2172" text-anchor="middle" font-size="11" fill="#94a3b8">Q Projection</text>
  <text x="430" y="2172" text-anchor="middle" font-size="11" fill="#93c5fd">[8, 2048, 256]  = 4.2M</text>
  <text x="780" y="2172" text-anchor="middle" font-size="11" fill="#fed7aa">[8, 1024, 256]  = 2.1M</text>
  <text x="1100" y="2172" text-anchor="middle" font-size="11" fill="#f87171">ë…ë¦½</text>
  <text x="1380" y="2172" text-anchor="middle" font-size="11" fill="#64748b">q_einsum / q_einsum_1</text>

  <!-- Row 2 -->
  <rect x="30" y="2182" width="1540" height="28" rx="0" fill="#1a2538"/>
  <text x="150" y="2200" text-anchor="middle" font-size="11" fill="#94a3b8">KV Projection</text>
  <text x="430" y="2200" text-anchor="middle" font-size="11" fill="#93c5fd">[2, 1, 2048, 256]  = 1.05M</text>
  <text x="780" y="2200" text-anchor="middle" font-size="11" fill="#fed7aa">[2, 1, 1024, 256]  = 0.52M</text>
  <text x="1100" y="2200" text-anchor="middle" font-size="11" fill="#f87171">ë…ë¦½</text>
  <text x="1380" y="2200" text-anchor="middle" font-size="11" fill="#64748b">GQA: num_kv=1, num_q=8</text>

  <!-- Row 3 -->
  <rect x="30" y="2210" width="1540" height="28" rx="0" fill="#131e2e"/>
  <text x="150" y="2228" text-anchor="middle" font-size="11" fill="#94a3b8">Out Projection</text>
  <text x="430" y="2228" text-anchor="middle" font-size="11" fill="#93c5fd">[8, 256, 2048]  = 4.2M</text>
  <text x="780" y="2228" text-anchor="middle" font-size="11" fill="#fed7aa">[8, 256, 1024]  = 2.1M</text>
  <text x="1100" y="2228" text-anchor="middle" font-size="11" fill="#f87171">ë…ë¦½</text>
  <text x="1380" y="2228" text-anchor="middle" font-size="11" fill="#64748b">attention ê²°ê³¼ë¥¼ ê° ì°¨ì›ìœ¼ë¡œ</text>

  <!-- Row 4 -->
  <rect x="30" y="2238" width="1540" height="28" rx="0" fill="#1a2538"/>
  <text x="150" y="2256" text-anchor="middle" font-size="11" fill="#94a3b8">FFN gating</text>
  <text x="430" y="2256" text-anchor="middle" font-size="11" fill="#93c5fd">[2, 2048, 16384] = 67M</text>
  <text x="780" y="2256" text-anchor="middle" font-size="11" fill="#fed7aa">[2, 1024, 4096]  = 8.4M</text>
  <text x="1100" y="2256" text-anchor="middle" font-size="11" fill="#f87171">ë…ë¦½</text>
  <text x="1380" y="2256" text-anchor="middle" font-size="11" fill="#64748b">GeGLU: gate Ã— linear</text>

  <!-- Row 5 -->
  <rect x="30" y="2266" width="1540" height="28" rx="0" fill="#131e2e"/>
  <text x="150" y="2284" text-anchor="middle" font-size="11" fill="#94a3b8">FFN linear</text>
  <text x="430" y="2284" text-anchor="middle" font-size="11" fill="#93c5fd">[16384, 2048]  = 33.6M</text>
  <text x="780" y="2284" text-anchor="middle" font-size="11" fill="#fed7aa">[4096, 1024]   = 4.2M</text>
  <text x="1100" y="2284" text-anchor="middle" font-size="11" fill="#f87171">ë…ë¦½</text>
  <text x="1380" y="2284" text-anchor="middle" font-size="11" fill="#64748b"></text>

  <!-- Row 6 -->
  <rect x="30" y="2294" width="1540" height="28" rx="0" fill="#1a2538"/>
  <text x="150" y="2312" text-anchor="middle" font-size="11" fill="#94a3b8">RMSNorm scales</text>
  <text x="430" y="2312" text-anchor="middle" font-size="11" fill="#93c5fd">2 Ã— [2048]  (pre_attn, pre_ffw)</text>
  <text x="780" y="2312" text-anchor="middle" font-size="11" fill="#fed7aa">2 Ã— [1024]</text>
  <text x="1100" y="2312" text-anchor="middle" font-size="11" fill="#f87171">ë…ë¦½</text>
  <text x="1380" y="2312" text-anchor="middle" font-size="11" fill="#64748b"></text>

  <!-- Row 7 -->
  <rect x="30" y="2322" width="1540" height="28" rx="0" fill="#131e2e"/>
  <text x="150" y="2340" text-anchor="middle" font-size="11" fill="#94a3b8">Attention Softmax</text>
  <text x="630" y="2340" text-anchor="middle" font-size="11" fill="#c084fc">í•˜ë‚˜ì˜ [4, 1, 8, 817, 817] í–‰ë ¬ â€” ë‘ Expert ê³µìœ </text>
  <text x="1100" y="2340" text-anchor="middle" font-size="11" fill="#4ade80">ê³µìœ </text>
  <text x="1380" y="2340" text-anchor="middle" font-size="11" fill="#64748b">Transfusion í•µì‹¬</text>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SECTION 9: DESIGN INSIGHTS -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <rect x="20" y="2366" width="1560" height="2" fill="#334155"/>
  <text x="30" y="2388" font-size="16" font-weight="bold" fill="#f1f5f9">â‘¨ ì„¤ê³„ í•µì‹¬ í¬ì¸íŠ¸ (Transfusion Architecture)</text>

  <rect x="30" y="2398" width="360" height="130" rx="8" fill="#0a1628" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="210" y="2418" text-anchor="middle" font-size="13" font-weight="bold" fill="#60a5fa">ë©€í‹°ëª¨ë‹¬ í†µí•©</text>
  <text x="50" y="2438" font-size="11" fill="#93c5fd">â€¢ ì´ë¯¸ì§€/ì–¸ì–´/í–‰ë™ í† í°ì´</text>
  <text x="50" y="2454" font-size="11" fill="#93c5fd">  ë™ì¼í•œ attention ê³µê°„ì—ì„œ êµë¥˜</text>
  <text x="50" y="2470" font-size="11" fill="#93c5fd">â€¢ Action Expertê°€ PaliGemmaì˜</text>
  <text x="50" y="2486" font-size="11" fill="#93c5fd">  ì§€ì‹ì„ ì§ì ‘ ì°¸ì¡° ê°€ëŠ¥</text>
  <text x="50" y="2502" font-size="11" fill="#93c5fd">â€¢ ì„œë¡œ ë‹¤ë¥¸ ì°¨ì›(2048/1024) â†’</text>
  <text x="50" y="2518" font-size="11" fill="#93c5fd">  ë™ì¼ head_dim=256 ìœ¼ë¡œ íˆ¬ì˜</text>

  <rect x="410" y="2398" width="360" height="130" rx="8" fill="#0a1628" stroke="#f97316" stroke-width="1.5"/>
  <text x="590" y="2418" text-anchor="middle" font-size="13" font-weight="bold" fill="#fb923c">Flow Matching</text>
  <text x="430" y="2438" font-size="11" fill="#fed7aa">â€¢ Diffusion ëŒ€ì‹  ODE ê²½ë¡œ ì‚¬ìš©</text>
  <text x="430" y="2454" font-size="11" fill="#fed7aa">â€¢ ì§ì„  ë³´ê°„: í•™ìŠµ ì•ˆì •ì„± â†‘</text>
  <text x="430" y="2470" font-size="11" fill="#fed7aa">â€¢ í•™ìŠµ: t~Beta(1.5,1), x_t=interp</text>
  <text x="430" y="2486" font-size="11" fill="#fed7aa">â€¢ ì¶”ë¡ : Euler 10íšŒ (DDIMë³´ë‹¤ ë‹¨ìˆœ)</text>
  <text x="430" y="2502" font-size="11" fill="#fed7aa">â€¢ u_t = noise-actions (ìƒìˆ˜ ë²¡í„°ì¥)</text>

  <rect x="790" y="2398" width="360" height="130" rx="8" fill="#0a1628" stroke="#a855f7" stroke-width="1.5"/>
  <text x="970" y="2418" text-anchor="middle" font-size="13" font-weight="bold" fill="#c084fc">GQA + KV Cache</text>
  <text x="810" y="2438" font-size="11" fill="#d8b4fe">â€¢ num_kv_heads=1, num_heads=8</text>
  <text x="810" y="2454" font-size="11" fill="#d8b4fe">  â†’ K,V ë©”ëª¨ë¦¬ 8ë°° ì ˆì•½</text>
  <text x="810" y="2470" font-size="11" fill="#d8b4fe">â€¢ Prefix ë¶ˆë³€ â†’ KV Cache ì¬ì‚¬ìš©</text>
  <text x="810" y="2486" font-size="11" fill="#d8b4fe">â€¢ ì¶”ë¡  ì†ë„ 10ë°° í–¥ìƒ</text>
  <text x="810" y="2502" font-size="11" fill="#d8b4fe">â€¢ ar_mask: prefixâ†’suffix ì°¨ë‹¨ì´</text>
  <text x="810" y="2518" font-size="11" fill="#d8b4fe">  KV Cache ì •í™•ì„± ë³´ì¥</text>

  <rect x="1170" y="2398" width="400" height="130" rx="8" fill="#0a1628" stroke="#10b981" stroke-width="1.5"/>
  <text x="1370" y="2418" text-anchor="middle" font-size="13" font-weight="bold" fill="#10b981">Ï€â‚€ vs Ï€â‚€.â‚…</text>
  <text x="1190" y="2438" font-size="11" fill="#6ee7b7">Ï€â‚€  : state í† í° + action+time MLP</text>
  <text x="1190" y="2454" font-size="11" fill="#6ee7b7">      adarms_cond=None</text>
  <text x="1190" y="2470" font-size="11" fill="#6ee7b7">      suffix=33 (state1+action32)</text>
  <text x="1190" y="2486" font-size="11" fill="#64748b">Ï€â‚€.â‚…: time MLP â†’ AdaRMS ì¡°ê±´ë¶€</text>
  <text x="1190" y="2502" font-size="11" fill="#64748b">      adarms_cond=time_emb</text>
  <text x="1190" y="2518" font-size="11" fill="#64748b">      suffix=32 (action only)</text>

  <!-- â”€â”€â”€ defs for arrow marker â”€â”€â”€ -->
  <defs>
    <marker id="arr" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L8,3 z" fill="#6366f1"/>
    </marker>
  </defs>

  <!-- footer -->
  <text x="800" y="2566" text-anchor="middle" font-size="12" fill="#475569">Source: openpi/src/openpi/models/pi0.py Â· gemma.py Â· siglip.py  |  Physical Intelligence (Ï€) 2024</text>
  <text x="800" y="2584" text-anchor="middle" font-size="12" fill="#475569">Transfusion: ì„œë¡œ ë‹¤ë¥¸ ì°¨ì›ì˜ ë‘ Expertê°€ í•˜ë‚˜ì˜ Softmax Attentionì„ ê³µìœ í•˜ë©° ìƒí˜¸ì‘ìš©í•˜ëŠ” êµ¬ì¡°</text>

</svg>
